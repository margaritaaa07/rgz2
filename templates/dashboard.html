<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ü–∞–Ω–µ–ª—å —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è - –ü–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –æ—Ç–ø—É—Å–∫–æ–≤</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { padding-top: 20px; background-color: #f8f9fa; }
        .navbar-brand { font-weight: bold; }
        .welcome-card { background: linear-gradient(135deg, #cb11c5 0%, #dd8ee6 100%); color: white; }
        .vacation-calendar { background-color: white; border-radius: 10px; padding: 20px; box-shadow: 0 0 10px rgba(0,0,0,0.1); }
        .week-cell { 
            width: 40px; height: 40px; 
            display: inline-flex; align-items: center; justify-content: center;
            margin: 2px; border: 1px solid #dee2e6; border-radius: 4px;
            cursor: pointer;
        }
        .week-cell.available { background-color: #d4edda; }
        .week-cell.booked { background-color: #f8d7da; }
        .week-cell.current { border: 2px solid #ff008c; font-weight: bold; }
        .week-cell:hover { opacity: 0.8; }
    </style>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
        <div class="container">
            <a class="navbar-brand" href="/dashboard">üìÖ –ü–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –æ—Ç–ø—É—Å–∫–æ–≤</a>
            <div class="navbar-nav ms-auto">
                <span class="nav-item nav-link">–ü—Ä–∏–≤–µ—Ç, {{ current_user.name }}!</span>
                <a class="nav-item nav-link" href="/profile">–ü—Ä–æ—Ñ–∏–ª—å</a>
                {% if current_user.is_admin %}
                <a class="nav-item nav-link" href="/admin">–ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å</a>
                {% endif %}
                <a class="nav-item nav-link" href="/logout">–í—ã–π—Ç–∏</a>
            </div>
        </div>
    </nav>

    <div class="container mt-4">
        <div class="card welcome-card mb-4">
            <div class="card-body">
                <h2>–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å, {{ current_user.name }}!</h2>
                <p class="mb-0">
                    {% if current_user.department %}
                    –û—Ç–¥–µ–ª: {{ current_user.department }}
                    {% endif %}
                    | ID: {{ current_user.id }}
                </p>
            </div>
        </div>

        <div class="row">
            <div class="col-md-8">
                <div class="vacation-calendar">
                    <h3>–ö–∞–ª–µ–Ω–¥–∞—Ä—å –æ—Ç–ø—É—Å–∫–æ–≤ –Ω–∞ {{ current_year }} –≥–æ–¥</h3>
                    <p>–í—Å–µ–≥–æ –Ω–µ–¥–µ–ª—å –≤ –≥–æ–¥—É: 52</p>

                    <div class="mb-3">
                        <label for="yearSelect" class="form-label">–í—ã–±–µ—Ä–∏—Ç–µ –≥–æ–¥:</label>
                        <select class="form-select" id="yearSelect" onchange="changeYear(this.value)">
                            {% for year in [2023, 2024, 2025, 2026] %}
                            <option value="{{ year }}" {% if year == current_year %}selected{% endif %}>{{ year }}</option>
                            {% endfor %}
                        </select>
                    </div>

                    <div class="mb-4">
                        {% for week in range(1, 53) %}
                        <div class="week-cell 
                            {% if week in user_vacations %}booked
                            {% elif week == current_week %}current
                            {% else %}available{% endif %}"
                            title="–ù–µ–¥–µ–ª—è {{ week }}" 
                            onclick="toggleVacation({{ week }})">
                            {{ week }}
                        </div>
                        {% if week % 13 == 0 %}<br>{% endif %}
                        {% endfor %}
                    </div>

                    <div class="row text-center">
                        <div class="col-md-4">
                            <div class="p-3 bg-light rounded">
                                <h5>–ó–∞–±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–æ</h5>
                                <h3>{{ user_vacations|length }}</h3>
                                <small>–Ω–µ–¥–µ–ª—å</small>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="p-3 bg-light rounded">
                                <h5>–î–æ—Å—Ç—É–ø–Ω–æ</h5>
                                <h3>{{ 28 - (user_vacations|length * 7) }}</h3>
                                <small>–¥–Ω–µ–π (4 –Ω–µ–¥–µ–ª–∏ –≤ –≥–æ–¥)</small>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="p-3 bg-light rounded">
                                <h5>–¢–µ–∫—É—â–∞—è</h5>
                                <h3>{{ current_week }}</h3>
                                <small>–Ω–µ–¥–µ–ª—è –≥–æ–¥–∞</small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="col-md-4">
                <div class="card mb-3">
                    <div class="card-header">
                        <h5>–í–∞—à –ø—Ä–æ—Ñ–∏–ª—å</h5>
                    </div>
                    <div class="card-body">
                        <p><strong>–ò–º—è:</strong> {{ current_user.name }}</p>
                        <p><strong>–õ–æ–≥–∏–Ω:</strong> {{ current_user.username }}</p>
                        {% if current_user.email %}
                        <p><strong>Email:</strong> {{ current_user.email }}</p>
                        {% endif %}
                        {% if current_user.department %}
                        <p><strong>–û—Ç–¥–µ–ª:</strong> {{ current_user.department }}</p>
                        {% endif %}
                        <p><strong>–°—Ç–∞—Ç—É—Å:</strong> 
                            <span class="badge {% if current_user.active %}bg-success{% else %}bg-danger{% endif %}">
                                {% if current_user.active %}–ê–∫—Ç–∏–≤–µ–Ω{% else %}–ù–µ–∞–∫—Ç–∏–≤–µ–Ω{% endif %}
                            </span>
                        </p>
                        <a href="/profile" class="btn btn-outline-primary btn-sm">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –ø—Ä–æ—Ñ–∏–ª—å</a>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header">
                        <h5>–ë—ã—Å—Ç—Ä—ã–µ –¥–µ–π—Å—Ç–≤–∏—è</h5>
                    </div>
                    <div class="card-body">
                        <div class="d-grid gap-2">
                            <button class="btn btn-success" onclick="selectVacationWeeks()">–ó–∞–±—Ä–æ–Ω–∏—Ä–æ–≤–∞—Ç—å –æ—Ç–ø—É—Å–∫</button>
                            <button class="btn btn-info" onclick="viewSchedule()">–ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å –≥—Ä–∞—Ñ–∏–∫ –æ—Ç–¥–µ–ª–∞</button>
                            <button class="btn btn-warning" onclick="exportSchedule()">–≠–∫—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å –≥—Ä–∞—Ñ–∏–∫</button>
                            {% if current_user.is_admin %}
                            <a href="/admin" class="btn btn-danger">–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–∏–≤–Ω–∞—è –ø–∞–Ω–µ–ª—å</a>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
        </div>

        {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
            <div class="mt-4">
                {% for category, message in messages %}
                <div class="alert alert-{{ category }} alert-dismissible fade show" role="alert">
                    {{ message }}
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>
                {% endfor %}
            </div>
            {% endif %}
        {% endwith %}
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        function changeYear(year) {
            window.location.href = `/dashboard?year=${year}`;
        }

        function toggleVacation(week) {
            fetch('/toggle_vacation', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    week: week,
                    year: document.getElementById('yearSelect').value
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    location.reload();
                } else {
                    alert(data.message || '–û—à–∏–±–∫–∞');
                }
            });
        }

        function selectVacationWeeks() {
            let year = document.getElementById('yearSelect').value;
            let weeks = prompt('–í–≤–µ–¥–∏—Ç–µ –Ω–æ–º–µ—Ä–∞ –Ω–µ–¥–µ–ª—å —á–µ—Ä–µ–∑ –∑–∞–ø—è—Ç—É—é (–Ω–∞–ø—Ä–∏–º–µ—Ä: 25,26,27,28):');
            if (weeks) {
                fetch('/add_vacation_weeks', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        weeks: weeks.split(',').map(w => parseInt(w.trim())),
                        year: parseInt(year)
                    })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        location.reload();
                    } else {
                        alert(data.message || '–û—à–∏–±–∫–∞');
                    }
                });
            }
        }

        function viewSchedule() {
            let year = document.getElementById('yearSelect').value;
            window.location.href = `/department_schedule?year=${year}`;
        }

        function exportSchedule() {
            let year = document.getElementById('yearSelect').value;
            window.open(`/export_schedule?year=${year}`, '_blank');
        }
    </script>
</body>
</html>