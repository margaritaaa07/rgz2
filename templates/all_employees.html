{% extends "base.html" %}

{% block title %}Все сотрудники | Планировщик отпусков{% endblock %}

{% block content %}
<div class="container">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1><i class="fas fa-users me-2"></i> Все сотрудники</h1>
        <div>
            <span class="badge bg-primary">Всего: {{ users_with_stats|length }}</span>
            <span class="badge bg-success ms-2">В этом году: {{ current_year }}</span>
        </div>
    </div>
    
    <div class="card mb-4">
        <div class="card-header">
            <i class="fas fa-chart-bar me-2"></i> Статистика команды
        </div>
        <div class="card-body">
            <div class="row text-center">
                <div class="col-md-3 mb-3">
                    <div class="stat-card">
                        <div class="stat-icon">
                            <i class="fas fa-users"></i>
                        </div>
                        <div class="stat-value">{{ users_with_stats|length }}</div>
                        <div class="stat-label">Всего сотрудников</div>
                    </div>
                </div>
                <div class="col-md-3 mb-3">
                    <div class="stat-card">
                        <div class="stat-icon">
                            <i class="fas fa-umbrella-beach"></i>
                        </div>
                        {% set total_vacations = namespace(count=0) %}
                        {% for user_stat in users_with_stats %}
                            {% set total_vacations.count = total_vacations.count + user_stat.total_vacations %}
                        {% endfor %}
                        <div class="stat-value">{{ total_vacations.count }}</div>
                        <div class="stat-label">Всего отпусков</div>
                    </div>
                </div>
                <div class="col-md-3 mb-3">
                    <div class="stat-card">
                        <div class="stat-icon">
                            <i class="fas fa-calendar-check"></i>
                        </div>
                        {% set current_year_vacations = namespace(count=0) %}
                        {% for user_stat in users_with_stats %}
                            {% set current_year_vacations.count = current_year_vacations.count + user_stat.current_year_vacations %}
                        {% endfor %}
                        <div class="stat-value">{{ current_year_vacations.count }}</div>
                        <div class="stat-label">Отпусков в {{ current_year }}</div>
                    </div>
                </div>
                <div class="col-md-3 mb-3">
                    <div class="stat-card">
                        <div class="stat-icon">
                            <i class="fas fa-percentage"></i>
                        </div>
                        <div class="stat-value">
                            {{ ((current_year_vacations.count / (users_with_stats|length * 4) * 100) if users_with_stats|length > 0 else 0)|round(1) }}%
                        </div>
                        <div class="stat-label">Заполненность отпусков</div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="card">
        <div class="card-header">
            <i class="fas fa-list me-2"></i> Список сотрудников
        </div>
        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-hover">
                    <thead>
                        <tr>
                            <th>#</th>
                            <th>Сотрудник</th>
                            <th>Логин</th>
                            <th>Статус</th>
                            <th>Всего отпусков</th>
                            <th>В {{ current_year }} году</th>
                            <th>Зарегистрирован</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for user_stat in users_with_stats %}
                            <tr class="{% if user_stat.user.id == current_user.id %}table-active{% endif %}">
                                <td>{{ loop.index }}</td>
                                <td>
                                    <div class="d-flex align-items-center">
                                        <div class="user-avatar me-3">
                                            {{ user_stat.user.name[0] if user_stat.user.name else 'U' }}
                                        </div>
                                        <div>
                                            <strong>{{ user_stat.user.name }}</strong>
                                            {% if user_stat.user.id == current_user.id %}
                                                <span class="badge bg-info ms-2">Вы</span>
                                            {% endif %}
                                        </div>
                                    </div>
                                </td>
                                <td>@{{ user_stat.user.username }}</td>
                                <td>
                                    <span class="badge {% if user_stat.user.is_admin %}badge-admin{% else %}badge-user{% endif %}">
                                        {% if user_stat.user.is_admin %}
                                            <i class="fas fa-crown me-1"></i> Админ
                                        {% else %}
                                            <i class="fas fa-user me-1"></i> Пользователь
                                        {% endif %}
                                    </span>
                                </td>
                                <td>
                                    <div class="d-flex align-items-center">
                                        <span class="me-2">{{ user_stat.total_vacations }}</span>
                                        <div class="progress flex-grow-1" style="height: 8px;">
                                            <div class="progress-bar" role="progressbar" 
                                                 style="width: {{ (user_stat.total_vacations / (loop.index * 4) * 100) if loop.index > 0 else 0 }}%">
                                            </div>
                                        </div>
                                    </div>
                                </td>
                                <td>
                                    <span class="badge {% if user_stat.current_year_vacations == 4 %}bg-success
                                                       {% elif user_stat.current_year_vacations == 0 %}bg-danger
                                                       {% else %}bg-warning{% endif %}">
                                        {{ user_stat.current_year_vacations }} / 4
                                    </span>
                                    {% if user_stat.current_year_vacations < 4 and current_year >= now.year %}
                                        <small class="text-muted d-block mt-1">Нужно еще {{ 4 - user_stat.current_year_vacations }}</small>
                                    {% endif %}
                                </td>
                                <td>{{ user_stat.user.created_at.strftime('%d.%m.%Y') }}</td>
                            </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            
            <div class="mt-4">
                <h5><i class="fas fa-info-circle me-2 text-primary"></i> Легенда статусов отпусков:</h5>
                <div class="d-flex flex-wrap gap-3 mt-2">
                    <span class="badge bg-success">4 / 4</span> <small>Все недели выбраны</small>
                    <span class="badge bg-warning">1-3 / 4</span> <small>Частично выбрано</small>
                    <span class="badge bg-danger">0 / 4</span> <small>Не выбрано</small>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}